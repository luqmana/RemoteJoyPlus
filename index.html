<!DOCTYPE html>
<html lang="en">

	<head>

 		<meta name="charset" content="utf-8" />
 		
 		<title>RemoteJoy over WebSockets</title>

	</head>

	<body>

		<h2>RemoteJoy</h2>

		<p>
			Export your PSP screen over http now! With WebSockets and canvas you can exhibit your PSP's display.
			<br />
			Based on TyRaNiD's original code extended with WebSockets support.
		</p>

		<table>
			<div id="status-video">Video: Not initialized.</div>
			<div id="status-control">Control: Not initialized.</div>
		</table>

		<canvas style="margin: auto 0;" id="screen-canvas" width="480" height="272"></canvas>

		<script type="text/JavaScript">

			// Compat things
			window.WebSocket = (typeof MozWebSocket == "function") ? MozWebSocket : WebSocket;

			window.pleaseClear = false;

			function get_ws_url() {
				
				var pcol;
				var u = document.URL;

				if (u.substring(0, 5) == "https") {
					
					pcol = "wss://";
					u = u.substr(8);

				} else {
					
					pcol = "ws://";
					if (u.substring(0, 4) == "http")
						u = u.substring(7);

				}

				u = u.split('/');
				return pcol + u[0];

			}

			var vsock = new WebSocket(get_ws_url(), "rj-video");
			
			try {
				
				vsock.onopen = function() {
					
					document.getElementById("status-video").style.backgroundColor = "#40ff40";
					document.getElementById("status-video").textContent = "Video: Connection Opened.";

					var sock = new WebSocket(get_ws_url(), "rj-control");

					sock.onopen = function() {

						document.getElementById("status-control").style.backgroundColor = "#40ff40";
						document.getElementById("status-control").textContent = "Control: Connection Opened.";

						function keyHandler(evt) {
							evt = evt || window.event;

							var e = evt.keyCode;
							var t = (evt.type == "keydown") ? 'd' : 'u';

							if (e == 37)				// LEFT
								sock.send(t + 'LEFT');
							else if (e == 38)			// UP
								sock.send(t + 'UP');
							else if (e == 39)			// RIGHT
								sock.send(t + 'RIGHT');
							else if (e == 40)			// DOWN
								sock.send(t + 'DOWN');
							else if (e == 90)			// Z
								sock.send(t + 'CROSS');
							else if (e == 88)			// X
								sock.send(t + 'CIRCLE');
							else if (e == 65)			// A
								sock.send(t + 'SQUARE');
							else if (e == 83)			// S
								sock.send(t + 'TRIANGLE');
							else if (e == 81)			// Q
								sock.send(t + 'LTRIGGER');
							else if (e == 87)			// W
								sock.send(t + 'RTRIGGER');
							else if (e == 13)			// ENTER
								sock.send(t + 'START');
							else if (e == 32)			// SPACE
								sock.send(t + 'SELECT');
							else if (e == 77)			// M
								sock.send(t + 'SCREEN');
							else if (e == 78)			// N
								sock.send(t + 'NOTE');
							else if (e == 61)			// =
								sock.send(t + 'VOLUP');
							else if (e == 109)			// -
								sock.send(t + 'VOLDOWN');
							else if (e == 8)			// BACKSPACE
								sock.send(t + 'HOME');
							

						}

						document.addEventListener('keydown', keyHandler);
						document.addEventListener('keyup', keyHandler);

						function cmdHandler(evt) {
							evt = evt || window.event;

							var e = evt.keyCode;

							if (e == 114) {
								
								sock.send('cTOGGLE_FULLCOLOUR');
								evt.preventDefault();
								return false;

							} else if (e == 115) {
								
								sock.send('cTOGGLE_SIZE');
								evt.preventDefault();
								return false;

							} else if (e == 116) {

								sock.send('cTOGGLE_SCREEN');
								evt.preventDefault();
								return false;

							}


						}

						document.addEventListener('keydown', cmdHandler);

					}

					sock.onmessage = function(msg) {
						
						var canvas = document.getElementById('screen-canvas');  
						var ctx = canvas.getContext('2d');

						var f = new FileReader();
						f.onload = function() {
							
							if (f.result == 'resize')
								window.pleaseClear = true;
							else if (f.result == 'clear')
								clear();

						}
						f.readAsBinaryString(msg.data);

					}

					sock.onclose = function() {
					
						document.getElementById("status-control").style.backgroundColor = "#ff4040";
						document.getElementById("status-control").textContent = "Control: Connection Closed.";

						document.onkeypress = document.onkeydown = document.onkeyup = null;

					}

				}

				function clear() {
					
					var canvas = document.getElementById('screen-canvas');  
					var ctx = canvas.getContext('2d');

					var imageData = ctx.createImageData(480, 270);

					for (var i = 0; i < 480*272*4; i += 4) {
						
						imageData.data[i] = 0;
						imageData.data[i+1] = 0;
						imageData.data[i+2] = 0;
						imageData.data[i+3] = 255;

					}

					ctx.putImageData(imageData, 0, 0);

				}

				function render(r) {
					
					var canvas = document.getElementById('screen-canvas');  
					var ctx = canvas.getContext('2d');

					var imageData = ctx.createImageData(480, 270);

					for (var i = 0; i < r.length; i += 8) {
						
						imageData.data[i] = r.charCodeAt(i) & 0xFF;
						imageData.data[i+1] = r.charCodeAt(i+1) & 0xFF;
						imageData.data[i+2] = r.charCodeAt(i+2) & 0xFF;
						imageData.data[i+3] = 255;
						imageData.data[i+4] = r.charCodeAt(i+4) & 0xFF;
						imageData.data[i+5] = r.charCodeAt(i+5) & 0xFF;
						imageData.data[i+6] = r.charCodeAt(i+6) & 0xFF;
						imageData.data[i+7] = 255;

					}

					ctx.putImageData(imageData, 0, 0);

				}

				vsock.onmessage = function(msg) {

					var img = msg.data;

					window.i = img;

					var canvas = document.getElementById('screen-canvas');  
					var ctx = canvas.getContext('2d');

					var reader = new FileReader();
					reader.onload = function() {

						render(reader.result);
						
					};
					reader.readAsBinaryString(img);

				}

				vsock.onclose = function() {
					
					document.getElementById("status-video").style.backgroundColor = "#ff4040";
					document.getElementById("status-video").textContent = "Video: Connection Closed.";

				}

			} catch (e) {
				
				alert("Exception: " + e);

			}

		</script>

	</body>

</html>