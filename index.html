<!DOCTYPE html>
<html lang="en">

	<head>

 		<meta name="charset" content="utf-8" />
 		
 		<title>RemoteJoy over WebSockets</title>

	</head>

	<body>

		<h2>RemoteJoy</h2>

		<p>
			Export your PSP screen over http now! With WebSockets and canvas you can exhibit your PSP's display.
			<br />
			Based on TyRaNiD's original code extended with WebSockets support.
		</p>

		<table>
			<div id="status">Not initialized.</div>
		</table>

		<canvas id="screen-canvas" width="480" height="272"></canvas>
		<img id="screen" width="480" height="272" />

		<script type="text/JavaScript">

			// Need to define this as firefox trunk namespaces web sockets.
			window.WebSocket = (typeof MozWebSocket == "function") ? MozWebSocket : WebSocket;

			function get_ws_url() {
				
				var pcol;
				var u = document.URL;

				if (u.substring(0, 5) == "https") {
					
					pcol = "wss://";
					u = u.substr(8);

				} else {
					
					pcol = "ws://";
					if (u.substring(0, 4) == "http")
						u = u.substring(7);

				}

				u = u.split('/');
				return pcol + u[0];

			}

			var sock = new WebSocket(get_ws_url(), "video-frame");
			
			try {
				
				sock.onopen = function() {
					
					document.getElementById("status").style.backgroundColor = "#40ff40";
					document.getElementById("status").textContent = "WebSocket Connection Opened.";

					sock.send("HI I LOVE YOU!");

					document.onkeydown = function(evt) {
						evt = evt || window.event;

						var e = evt.keyCode;

						if (e == 37)
							sock.send('dLEFT');
						else if (e == 38)
							sock.send('dUP');
						else if (e == 39)	
							sock.send('dRIGHT');
						else if (e == 40)	
							sock.send('dDOWN');

					}

					document.onkeyup = function(evt) {
						evt = evt || window.event;

						var e = evt.keyCode;

						if (e == 37)
							sock.send('uLEFT');
						else if (e == 38)
							sock.send('uUP');
						else if (e == 39)	
							sock.send('uRIGHT');
						else if (e == 40)	
							sock.send('uDOWN');

					}

				}

				sock.onmessage = function(msg) {

					var img = msg.data;

					window.i = img;

					var canvas = document.getElementById('screen-canvas');  
					var ctx = canvas.getContext('2d');

					var reader = new FileReader();
					reader.onload = function() {
						
						var image = new Image();
						//var image = document.getElementById("screen");
						image.onload = function() {
							
							ctx.drawImage(image, 0, 0);

						};

						image.src = "data:image/x-windows-bmp;base64," + window.btoa(reader.result);/*
						window.r = reader;

						var imageData = ctx.createImageData(480, 272);

						imageData.data = reader.result;

						ctx.putImageData(imageData, 0, 0);*/

					};
					reader.readAsBinaryString(img);
					//reader.readAsArrayBuffer(img);

				}

				sock.onclose = function() {
					
					document.getElementById("status").style.backgroundColor = "#ff4040";
					document.getElementById("status").textContent = "WebSocket Connection Closed.";

				}

			} catch (e) {
				
				alert("Exception: " + e);

			}

		</script>

	</body>

</html>
